name: Release
run-name: Release @ Aegis Icons - ${{ github.sha }}

on:
  schedule:
    - cron: "0 0 1 * *"   # 00:00 UTC on the 1st of each month
  workflow_dispatch:

env:
  zipname: aegis-icons.zip

jobs:
  release:
    name: Release
    runs-on: ubuntu-latest

    steps:
      - name: Get current date
        run: |
          echo "DATE_ISO=$(date +'%Y-%m-%d')" >> $GITHUB_ENV
          echo "DATE_INT=$(date +'%Y%m%d')" >> $GITHUB_ENV

      - name: Checkout
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: Execute py script (gen-def)
        run: python make-pack.py gen-def

      - name: Commit json
        uses: stefanzweifel/git-auto-commit-action@v4
        with:
          commit_message: Update pack.json

      - name: Execute py script (generate ZIP)
        run: python make-pack.py gen --output ${{ env.zipname }} --version ${{ env.DATE_INT }}

      - name: Build Changelog
        id: build_changelog
        uses: mikepenz/release-changelog-builder-action@v4
        with:
          configurationJson: |
            {
              "ignore_on_undeclared_labels": true,
              "categories": [
                {
                  "title": "## New icons",
                  "labels": ["Submission", "New Icon", "new-icon"]
                },
                {
                  "title": "## Updated icons",
                  "labels": ["Update", "update"]
                }
              ],
              "template": "#{{CHANGELOG}}",
              "pr_template": "- #{{TITLE}} (thanks to @#{{AUTHOR}}) ##{{NUMBER}}"
            }
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Generate Renamed Icons List
        id: renamed_icons
        shell: python
        run: |
          import subprocess
          import os
          import re

          try:
              prev_tag = subprocess.check_output(["git", "describe", "--tags", "--abbrev=0"]).decode("utf-8").strip()
          except subprocess.CalledProcessError:
              prev_tag = ""

          output_md = ""

          if prev_tag:
              cmd_add = ["git", "diff", "--diff-filter=A", "--name-only", "-z", prev_tag, "HEAD", "--", "icons/"]
              try:
                  add_out = subprocess.check_output(cmd_add).decode("utf-8")
              except subprocess.CalledProcessError:
                  add_out = ""

              if add_out:
                  added = []
                  for path in add_out.split('\0'):
                      if path and path.endswith('.svg'):
                          name = os.path.splitext(os.path.basename(path))[0]
                          try:
                              log_out = subprocess.check_output(["git", "log", "-1", "--format=%s%n%b", "--diff-filter=A", f"{prev_tag}..HEAD", "--", path]).decode("utf-8").strip()
                          except:
                              log_out = ""

                          if not (re.search(r'\(#\d+\)', log_out) or "Merge pull request #" in log_out):
                              try:
                                  author = subprocess.check_output(["git", "log", "-1", "--format=%an", "--diff-filter=A", f"{prev_tag}..HEAD", "--", path]).decode("utf-8").strip()
                              except:
                                  author = ""
                              
                              added.append(f"- {name} (thanks to @{author})")
                  if added:
                      added.sort()
                      output_md += "\n## New icons\n" + "\n".join(added)

              cmd = ["git", "diff", "--diff-filter=R", "--name-status", "-z", prev_tag, "HEAD", "--", "icons/"]
              try:
                  diff_out = subprocess.check_output(cmd).decode("utf-8")
              except subprocess.CalledProcessError:
                  diff_out = ""

              if diff_out:
                  parts = diff_out.split('\0')
                  if parts and parts[-1] == "":
                      parts.pop()
                  
                  renames = []
                  i = 0
                  while i < len(parts):
                      status = parts[i]
                      if status.startswith('R'):
                          if i + 2 < len(parts):
                              old_path = parts[i+1]
                              new_path = parts[i+2]
                              if old_path.endswith('.svg') and new_path.endswith('.svg'):
                                  old_name = os.path.splitext(os.path.basename(old_path))[0]
                                  new_name = os.path.splitext(os.path.basename(new_path))[0]
                                  renames.append(f"- {old_name} â†’ {new_name}")
                              i += 3
                          else:
                              break
                      else:
                          i += 1
                  
                  if renames:
                      renames.sort()
                      output_md += "\n## Renamed icons\n" + "\n".join(renames)

              cmd_del = ["git", "diff", "--diff-filter=D", "--name-only", "-z", prev_tag, "HEAD", "--", "icons/"]
              try:
                  del_out = subprocess.check_output(cmd_del).decode("utf-8")
              except subprocess.CalledProcessError:
                  del_out = ""

              if del_out:
                  deletions = []
                  for path in del_out.split('\0'):
                      if path and path.endswith('.svg'):
                          name = os.path.splitext(os.path.basename(path))[0]
                          try:
                              reason = subprocess.check_output(["git", "log", "-1", "--format=%s", "--diff-filter=D", f"{prev_tag}..HEAD", "--", path]).decode("utf-8").strip()
                          except:
                              reason = ""

                          if reason:
                              deletions.append(f"- {name} *({reason})*")
                          else:
                              deletions.append(f"- {name}")
                  if deletions:
                      deletions.sort()
                      output_md += "\n## Removed icons\n" + "\n".join(deletions)

          with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
              f.write("list<<EOF\n")
              f.write(output_md)
              f.write("\nEOF\n")

      - name: Generate Release Notes
        run: |
          cat <<EOF > release_notes.md
          #### :question: Didn't find an icon from the pack? [have a look on the website](https://aegis-icons.github.io) first before making new issues!

          ### :package: [Latest ZIP Download](https://github.com/aegis-icons/aegis-icons/releases/latest/download/aegis-icons.zip) 

          #### :memo: Help how to: [install](https://github.com/aegis-icons/aegis-icons/blob/master/FAQ.md#with-icon-pack) or [update](https://github.com/aegis-icons/aegis-icons/blob/master/FAQ.md#how-to-update-the-icon-pack)

          ---
          ${{ steps.build_changelog.outputs.changelog }}
          ${{ steps.renamed_icons.outputs.list }}
          EOF
          cat release_notes.md

      - name: Create a GitHub release
        uses: softprops/action-gh-release@v0.1.15
        with:
          files: ${{ env.zipname }}
          name: ${{ env.DATE_ISO }}
          tag_name: ${{ env.DATE_ISO }}
          body_path: release_notes.md
