name: Release
run-name: Release @ Aegis Icons - ${{ github.sha }}

on:
  schedule:
    - cron: "0 0 1 * *"   # 00:00 UTC on the 1st of each month
  workflow_dispatch:

env:
  zipname: aegis-icons.zip

jobs:
  release:
    name: Release
    runs-on: ubuntu-latest

    steps:
      - name: Get current date
        run: |
          echo "DATE_ISO=$(date +'%Y-%m-%d')" >> $GITHUB_ENV
          echo "DATE_INT=$(date +'%Y%m%d')" >> $GITHUB_ENV

      - name: Checkout
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: Execute py script (gen-def)
        run: python make-pack.py gen-def

      - name: Commit json
        uses: stefanzweifel/git-auto-commit-action@v4
        with:
          commit_message: Update pack.json

      - name: Detect icon changes
        id: detect
        run: |
          git config --global core.quotePath false

          LAST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")

          if [ -z "$LAST_TAG" ]; then
            CHANGED=$(git ls-files icons/)
            NEW="$CHANGED"
            UPDATED=""
            MISC=""
          else
            CHANGED=$(git diff --name-status "$LAST_TAG" -- icons/)
            NEW=$(echo "$CHANGED" | awk '/^A/ {print $2}')
            UPDATED=$(echo "$CHANGED" | awk '/^M/ {print $2}')
            MISC=$(echo "$CHANGED" | awk '/^D/ {print $2}')
          fi

          if [ -z "$CHANGED" ]; then
            echo "changed=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "changed=true" >> $GITHUB_OUTPUT

          {
            echo "new<<EOF"
            echo "$NEW"
            echo "EOF"
          } >> $GITHUB_OUTPUT

          {
            echo "updated<<EOF"
            echo "$UPDATED"
            echo "EOF"
          } >> $GITHUB_OUTPUT

          {
            echo "misc<<EOF"
            echo "$MISC"
            echo "EOF"
          } >> $GITHUB_OUTPUT

      - name: Collect PR authors
        if: steps.detect.outputs.changed == 'true'
        id: authors
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          NEW_FILES: ${{ steps.detect.outputs.new }}
          UPDATED_FILES: ${{ steps.detect.outputs.updated }}
          MISC_FILES: ${{ steps.detect.outputs.misc }}
        run: |
          get_author() {
            FILE="$1"
            COMMIT=$(git log -1 --pretty=format:%H -- "$FILE")
            if [ -z "$COMMIT" ]; then
              echo ""
              return
            fi
            PR=$(gh pr list --search "$COMMIT" --state merged --json number,author --jq '.[0]')
            if [ -n "$PR" ]; then
              NUMBER=$(echo "$PR" | jq -r '.number')
              AUTHOR=$(echo "$PR" | jq -r '.author.login')
              echo "$AUTHOR (PR #$NUMBER)"
            else
              echo ""
            fi
          }

          build_list() {
            INPUT="$1"
            OUTPUT=""
            SAVEIFS=$IFS
            IFS=$'\n'
            for f in $INPUT; do
              if [ -z "$f" ]; then continue; fi
              ICON=$(basename "$f" .svg)
              AUTHOR=$(get_author "$f")
              if [ -n "$AUTHOR" ]; then
                OUTPUT+="- $ICON *(thanks to @$AUTHOR!)*\n"
              else
                OUTPUT+="- $ICON\n"
              fi
            done
            IFS=$SAVEIFS
            echo -e "$OUTPUT"
          }

          NEW_LIST=$(build_list "$NEW_FILES" | sort)
          UPDATED_LIST=$(build_list "$UPDATED_FILES" | sort)
          MISC_LIST=$(build_list "$MISC_FILES" | sort)

          {
            echo "new_list<<EOF"
            echo "$NEW_LIST"
            echo "EOF"
          } >> $GITHUB_OUTPUT

          {
            echo "updated_list<<EOF"
            echo "$UPDATED_LIST"
            echo "EOF"
          } >> $GITHUB_OUTPUT

          {
            echo "misc_list<<EOF"
            echo "$MISC_LIST"
            echo "EOF"
          } >> $GITHUB_OUTPUT

      - name: Build release body
        if: steps.detect.outputs.changed == 'true'
        id: body
        env:
          UPDATED_LIST: ${{ steps.authors.outputs.updated_list }}
          NEW_LIST: ${{ steps.authors.outputs.new_list }}
          MISC_LIST: ${{ steps.authors.outputs.misc_list }}
        run: |
          BODY=$(cat <<'EOF'
#### :question: Didn't find an icon from the pack? [Check it from our website](https://aegis-icons.github.io) first before making new issues!

### :package: [Latest ZIP Download](https://github.com/aegis-icons/aegis-icons/releases/latest/download/aegis-icons.zip)

#### :memo: Help how to: [install](https://github.com/aegis-icons/aegis-icons/blob/master/FAQ.md#with-icon-pack) â€¢ [update](https://github.com/aegis-icons/aegis-icons/blob/master/FAQ.md#how-to-update-the-icon-pack)

---
EOF
)

          BODY+="\n## Updated icons\n"
          BODY+="${UPDATED_LIST:-*(none)*}\n"

          BODY+="\n## New icons\n"
          BODY+="${NEW_LIST:-*(none)*}\n"

          BODY+="\n## Misc\n"
          if [ -n "$MISC_LIST" ]; then
            BODY+="**Icons moved to outdated:**\n$MISC_LIST\n"
          else
            BODY+="*(none)*\n"
          fi

          {
            echo "body<<EOF"
            echo "$BODY"
            echo "EOF"
          } >> $GITHUB_OUTPUT

      - name: Execute py script (generate ZIP)
        run: python make-pack.py gen --output ${{ env.zipname }} --version ${{ env.DATE_INT }}

      - name: Create a GitHub release
        if: steps.detect.outputs.changed == 'true'
        uses: softprops/action-gh-release@v0.1.15
        with:
          files: ${{ env.zipname }}
          name: ${{ env.DATE_ISO }}
          tag_name: ${{ env.DATE_ISO }}
          body: ${{ steps.body.outputs.body }}
